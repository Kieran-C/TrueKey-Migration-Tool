name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller tkinterdnd2 Pillow
      
      - name: Build executable
        run: |
          pyinstaller --name="TrueKey-Migration-Tool" `
            --onefile `
            --windowed `
            --icon=icon.ico `
            --add-data "icon.ico;." `
            --add-data "gui;gui" `
            --add-data "converter.py;." `
            --hidden-import=tkinter `
            --hidden-import=tkinter.ttk `
            --hidden-import=tkinter.font `
            --hidden-import=tkinter.filedialog `
            --hidden-import=tkinter.messagebox `
            --hidden-import=tkinterdnd2 `
            --hidden-import=gui `
            --hidden-import=gui.app `
            --hidden-import=gui.widgets `
            --hidden-import=gui.styles `
            --hidden-import=csv `
            --hidden-import=io `
            --collect-submodules=tkinter `
            --collect-all=tkinterdnd2 `
            --clean `
            main.py
      
      - name: Verify build
        run: |
          if (Test-Path "dist/TrueKey-Migration-Tool.exe") {
            Write-Host "Build successful!"
            $size = (Get-Item "dist/TrueKey-Migration-Tool.exe").Length / 1MB
            Write-Host "File size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "Build failed - executable not found"
            exit 1
          }
      
      - name: Extract version from tag
        id: get_version
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: TrueKey Migration Tool ${{ github.ref_name }}
          body: |
            ## üéâ Release ${{ github.ref_name }}
            
            ### üì• Download
            Download `TrueKey-Migration-Tool.exe` below and double-click to run. No installation required!
            
            ### ‚ö†Ô∏è Windows Security Warning
            Windows may show a security warning because the app isn't code-signed. Click "More info" then "Run anyway" to proceed safely.
            
            ### ‚ú® What's New
            <!-- Add release notes here -->
            
            ### üìñ Documentation
            See the [README](../../blob/main/README.md) for detailed usage instructions.
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD
          files: |
            dist/TrueKey-Migration-Tool.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: dist/TrueKey-Migration-Tool.exe
          retention-days: 7
